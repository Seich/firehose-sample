<html>
<head>
  <script type="text/javascript" src="/_ah/channel/jsapi"></script>
<style type="text/css">
  body {
    font-family: sans-serif;
    font-size: 10pt;
  }
  a {
    text-decoration: none;
  }
  div {
    width: 250px;
  }
  .header {
    background-color: #E0E0F0;
    color: #0F0F0F;
    padding: 5px;
    font-weight: bold;
    font-size: 13pt;
  }
  .header-filter {
    font-style: italic;
    font-size: 10pt;
  }
  .item {
    padding: 5px;
  }
  .odd {
    background-color: #F0FFFF;
  }
  .item-title {
  }
  .item-detail {
    font-style: italic;
    color: #2020FF;
  }
  .item-date {
    font-style: italic;
  }
  .item-challenge {
    font-style: italic;
    color: red;
  }
  .events {
    padding-bottom: 10px;
  }
  
  .infoparent {
    width: 250px;
  }
  
  .infopic {
    float: left;
    width: 50px;
  }
  
  .infotext {
    float: right;
    width: 200px;
  }
</style>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="http://maps.google.com/maps/api/js?sensor=false">
</script>
<script type="text/javascript">
  var known_entries = {};
  var map = undefined;
  var infoWindow = undefined;
  
  function initialize() {
    var latlng = new google.maps.LatLng(47.5, -122.2);
    var myOptions = {
      zoom: 2,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"),
        myOptions);
  }
  
  function makeInfoWindowContent(msg) {
    return "<div class='infoparent'><div class='infopic'><img src='" + 
        msg['person']['photo_url'] + "'></div>" +
        "<div class='infotext'>" +
        msg['entry-content'] +
        "</div></div>"
  }

  var onopen = function() {
  };
  var onclose = function() {
  };
  var onerror = function(err) {
  };
  var onmessage = function(evt) {
    var msgs = JSON.parse(evt.data);
    for (var i = 0; i < msgs.length; i++) {
      msg = msgs[i];
      if (!known_entries[msg['id']]) {
        if (msg['latlng']) {
          var latlng = new google.maps.LatLng(msg['latlng']['lat'], msg['latlng']['lng']);
          var marker = new google.maps.Marker({
              position: latlng, 
              map: map,
              title:msg['entry'],
              animation: google.maps.Animation.DROP
          });
          if (infoWindow) {
            infoWindow.close();
          }
          content = makeInfoWindowContent(msg);
          infoWindow = new google.maps.InfoWindow({
              position: latlng,
              content: content
          });
//          infoWindow.open(map, marker);
          known_entries[msg['id']] = 1;
          document.getElementById('first-activity').innerHTML += '<div>' + msg['entry'] + '</div>';
        }
      } else {
        document.getElementById('first-activity').innerHTML += '.';
      }
    }
  }
</script>
</head>
<body onload="initialize()">
<script type="text/javascript">
  var channel = new goog.appengine.Channel('{{ token }}');
  var handler = {
             'onopen': onopen,
             'onclose': onclose,
             'onerror': onerror,
             'onmessage': onmessage
             };
  var socket = channel.open(handler);
</script>
<div id="map_canvas" style="width:100%; height:100%"></div>
  <div class='events'>
    <div class='header'>
      <span class='header-title'>Events near you</span>
      <span class='header-filter'><a href=''>Filter</a></span>    
    </div>
    <div class='items'>
      <div class='item even'>
        <div class='item-title'>
          <span class='item-name'><a href='http://www.buduracing.com/pdf/mt%20bike%20race%20flier%202011.pdf'>West Side Mt. Bike Series #1</a></span>
          <span class='item-date'>February 20</span>
        </div>
        <div class='item-detail'>be the first Googler to sign up!</div>
      </div>    
      <div class='item odd'>
        <div class='item-title'>
          <span class='item-name'><a href='http://www.whidbeyislandmarathon.com/'>Whidbey Island Marathon</a></span>
          <span class='item-date'>April 10</span>
        </div>
        <div class='item-detail'>4 Googlers are attending</div>
      </div>    
      <div class='item even'>
        <div class='item-title'>
          <span class='item-name'>Capitol City Marathon</span>
          <span class='item-date'>May 15</span>
        </div>
        <div class='item-detail'>6 Googlers are attending</div>
        <div class='item-challenge'>This event has a Googler Challenge!</div>
      </div>    
    </div>
  </div>
  <div class='activity'>
    <div class='header'>
      <span class='header-title'>Your friends' activities</span>
      <span class='header-filter'><a href=''>Filter</a></span>    
    </div>
    <div class='items' id='activity-items'>
      <div class='item even' id='first-activity'>
        <div class='item-title'>
          <span class='item-user'><a href='https://googlewho.appspot.com/skoga'>Shuichi</a><span>
          <span class='item-name'>ran 4 miles</span>
          <span class='item-date'>January 28</span>
        </div>
      </div>    
    </div>
    <div class='items'>
      <div class='item odd'>
        <div class='item-title'>
          <span class='item-user'><a href='http://googlewho.appspot.com/scali'>Chris</a><span>
          <span class='item-name'>ran 2 miles</span>
          <span class='item-date'>January 28</span>
        </div>
      </div>    
    </div>
    <div class='items'>
      <div class='item even'>
        <div class='item-title'>
          <span class='item-user'><a href='http://googlewho.appspot.com/levin'>David</a><span>
          <span class='item-name'>ran 5 miles</span>
          <span class='item-date'>January 27</span>
        </div>
      </div>    
    </div>
  </div>
</body>
</html>